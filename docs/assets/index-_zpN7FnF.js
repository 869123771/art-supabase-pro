var e=(e,t,r)=>new Promise((n,a)=>{var i=e=>{try{s(r.next(e))}catch(t){a(t)}},o=e=>{try{s(r.throw(e))}catch(t){a(t)}},s=e=>e.done?n(e.value):Promise.resolve(e.value).then(i,o);s((r=r.apply(e,t)).next())});import{x as t,dw as r,dx as n}from"./index-D2YTfifR.js";const{supabase:a,responseHandle:i}=r();function o(r){return e(this,null,function*(){const{getUserInfo:e}=t(),{table:n,field:o,value:s,excludeId:c,extraWhere:l}=r;let u=a.from(n).select("id",{count:"exact",head:!0}).eq(o,s).eq("create_by",e.email);return c&&(u=u.neq("id",c)),l&&Object.entries(l).forEach(([e,t])=>{null!=t&&(u=u.eq(e,t))}),yield i(()=>u,{ignoreCheck:!0})})}function s(r,o){return e(this,null,function*(){const{getUserInfo:{userName:o,nickName:s}}=t(),{bucket:l="attachments",createBy:u=o||s,remark:f="",concurrency:y=3}={},d=Array.isArray(r)?r:[r],h=[...d],m=[];return yield Promise.all(Array.from({length:Math.min(y,d.length)},()=>function(){return e(this,null,function*(){for(;h.length;){const t=h.shift();if(!t)return;try{const e=yield p(t);m.push(e)}catch(e){}}})}())),m;function p(t){return e(this,null,function*(){const r=yield function(t){return e(this,null,function*(){const e=yield t.arrayBuffer(),r=yield crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(r)).map(e=>e.toString(16).padStart(2,"0")).join("")})}(t),{data:o}=yield a.from("attachment").select("*").eq("hash",r).maybeSingle();if(o)return o;const s=t.name.split(".").pop()||"",y=`${r}.${s}`,d=n().format("YYYY/MM/DD"),h=`${d}/${y}`;yield i(()=>a.storage.from(l).upload(h,t,{upsert:!1,contentType:t.type}),{breakReturn:!0,showMessage:!1});const{data:m}=yield i(()=>a.storage.from(l).getPublicUrl(h),{ignoreCheck:!0}),p={storage_mode:"supabase",origin_name:t.name,object_name:y,hash:r,mime_type:t.type,storage_path:d,suffix:s,size_byte:t.size,size_info:c(t.size),url:m.publicUrl,create_by:u,update_by:u,remark:f},g=yield a.from("attachment").insert(p).select().single();return yield i(()=>g,{ignoreCheck:!0,showMessage:!0})})}})}function c(e){return e<1024?e+" B":e<1048576?(e/1024).toFixed(2)+" KB":e<1073741824?(e/1024/1024).toFixed(2)+" MB":(e/1024/1024/1024).toFixed(2)+" GB"}export{o as c,s as u};
