var e=Object.defineProperty,t=Object.defineProperties,r=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,i=e=>{throw TypeError(e)},o=(t,r,s)=>r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[r]=s,l=(e,t)=>{for(var r in t||(t={}))n.call(t,r)&&o(e,r,t[r]);if(s)for(var r of s(t))a.call(t,r)&&o(e,r,t[r]);return e},c=(e,t,r)=>o(e,"symbol"!=typeof t?t+"":t,r),u=(e,t,r)=>(((e,t,r)=>{t.has(e)||i("Cannot "+r)})(e,t,"read from private field"),r?r.call(e):t.get(e)),h=(e,t,r)=>new Promise((s,n)=>{var a=e=>{try{o(r.next(e))}catch(t){n(t)}},i=e=>{try{o(r.throw(e))}catch(t){n(t)}},o=e=>e.done?s(e.value):Promise.resolve(e.value).then(a,i);o((r=r.apply(e,t)).next())});import{a as d,c as f,r as g,aO as y,bj as p,o as m,aF as C,c9 as v,n as b}from"./index-CSMnfbno.js";import{d as A,t as w,c as $,u as _,e as z,a as E}from"./el-space-Da41OEmb.js";const B=function(){var e;class t{constructor(){var t,r,s;t=this,r=e,s=new Map,r.has(t)?i("Cannot add the same private member more than once"):r instanceof WeakSet?r.add(t):r.set(t,s)}compare(e,t){const r=typeof e,s=typeof t;return"string"===r&&"string"===s?e.localeCompare(t):"number"===r&&"number"===s?e-t:String.prototype.localeCompare.call(this.serialize(e,!0),this.serialize(t,!0))}serialize(e,t){if(null===e)return"null";switch(typeof e){case"string":return t?e:`'${e}'`;case"bigint":return`${e}n`;case"object":return this.$object(e);case"function":return this.$function(e)}return String(e)}serializeObject(e){const t=Object.prototype.toString.call(e);if("[object Object]"!==t)return this.serializeBuiltInType(t.length<10?`unknown:${t}`:t.slice(8,-1),e);const r=e.constructor,s=r===Object||void 0===r?"":r.name;if(""!==s&&globalThis[s]===r)return this.serializeBuiltInType(s,e);if("function"==typeof e.toJSON){const t=e.toJSON();return s+(null!==t&&"object"==typeof t?this.$object(t):`(${this.serialize(t)})`)}return this.serializeObjectEntries(s,Object.entries(e))}serializeBuiltInType(e,t){const r=this["$"+e];if(r)return r.call(this,t);if("function"==typeof(null==t?void 0:t.entries))return this.serializeObjectEntries(e,t.entries());throw new Error(`Cannot serialize ${e}`)}serializeObjectEntries(e,t){const r=Array.from(t).sort((e,t)=>this.compare(e[0],t[0]));let s=`${e}{`;for(let n=0;n<r.length;n++){const[e,t]=r[n];s+=`${this.serialize(e,!0)}:${this.serialize(t)}`,n<r.length-1&&(s+=",")}return s+"}"}$object(t){let r=u(this,e).get(t);return void 0===r&&(u(this,e).set(t,`#${u(this,e).size}`),r=this.serializeObject(t),u(this,e).set(t,r)),r}$function(e){const t=Function.prototype.toString.call(e);return"[native code] }"===t.slice(-15)?`${e.name||""}()[native]`:`${e.name}(${e.length})${t.replace(/\s*\n\s*/g,"")}`}$Array(e){let t="[";for(let r=0;r<e.length;r++)t+=this.serialize(e[r]),r<e.length-1&&(t+=",");return t+"]"}$Date(e){try{return`Date(${e.toISOString()})`}catch(t){return"Date(null)"}}$ArrayBuffer(e){return`ArrayBuffer[${new Uint8Array(e).join(",")}]`}$Set(e){return`Set${this.$Array(Array.from(e).sort((e,t)=>this.compare(e,t)))}`}$Map(e){return this.serializeObjectEntries("Map",e.entries())}}e=new WeakMap;for(const r of["Error","RegExp","URL"])t.prototype["$"+r]=function(e){return`${r}(${e})`};for(const r of["Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array"])t.prototype["$"+r]=function(e){return`${r}[${e.join(",")}]`};for(const r of["BigInt64Array","BigUint64Array"])t.prototype["$"+r]=function(e){return`${r}[${e.join("n,")}${e.length>0?"n":""}]`};return t}(),R=[1779033703,-1150833019,1013904242,-1521486534,1359893119,-1694144372,528734635,1541459225],L=[1116352408,1899447441,-1245643825,-373957723,961987163,1508970993,-1841331548,-1424204075,-670586216,310598401,607225278,1426881987,1925078388,-2132889090,-1680079193,-1046744716,-459576895,-272742522,264347078,604807628,770255983,1249150122,1555081692,1996064986,-1740746414,-1473132947,-1341970488,-1084653625,-958395405,-710438585,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,-2117940946,-1838011259,-1564481375,-1474664885,-1035236496,-949202525,-778901479,-694614492,-200395387,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,-2067236844,-1933114872,-1866530822,-1538233109,-1090935817,-965641998],j=[];class O{constructor(){c(this,"_data",new T),c(this,"_hash",new T([...R])),c(this,"_nDataBytes",0),c(this,"_minBufferSize",0)}finalize(e){e&&this._append(e);const t=8*this._nDataBytes,r=8*this._data.sigBytes;return this._data.words[r>>>5]|=128<<24-r%32,this._data.words[14+(r+64>>>9<<4)]=Math.floor(t/4294967296),this._data.words[15+(r+64>>>9<<4)]=t,this._data.sigBytes=4*this._data.words.length,this._process(),this._hash}_doProcessBlock(e,t){const r=this._hash.words;let s=r[0],n=r[1],a=r[2],i=r[3],o=r[4],l=r[5],c=r[6],u=r[7];for(let h=0;h<64;h++){if(h<16)j[h]=0|e[t+h];else{const e=j[h-15],t=(e<<25|e>>>7)^(e<<14|e>>>18)^e>>>3,r=j[h-2],s=(r<<15|r>>>17)^(r<<13|r>>>19)^r>>>10;j[h]=t+j[h-7]+s+j[h-16]}const r=s&n^s&a^n&a,d=(s<<30|s>>>2)^(s<<19|s>>>13)^(s<<10|s>>>22),f=u+((o<<26|o>>>6)^(o<<21|o>>>11)^(o<<7|o>>>25))+(o&l^~o&c)+L[h]+j[h];u=c,c=l,l=o,o=i+f|0,i=a,a=n,n=s,s=f+(d+r)|0}r[0]=r[0]+s|0,r[1]=r[1]+n|0,r[2]=r[2]+a|0,r[3]=r[3]+i|0,r[4]=r[4]+o|0,r[5]=r[5]+l|0,r[6]=r[6]+c|0,r[7]=r[7]+u|0}_append(e){"string"==typeof e&&(e=T.fromUtf8(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes}_process(e){let t,r=this._data.sigBytes/64;r=e?Math.ceil(r):Math.max((0|r)-this._minBufferSize,0);const s=16*r,n=Math.min(4*s,this._data.sigBytes);if(s){for(let e=0;e<s;e+=16)this._doProcessBlock(this._data.words,e);t=this._data.words.splice(0,s),this._data.sigBytes-=n}return new T(t,n)}}class T{constructor(e,t){c(this,"words"),c(this,"sigBytes"),e=this.words=e||[],this.sigBytes=void 0===t?4*e.length:t}static fromUtf8(e){const t=unescape(encodeURIComponent(e)),r=t.length,s=[];for(let n=0;n<r;n++)s[n>>>2]|=(255&t.charCodeAt(n))<<24-n%4*8;return new T(s,r)}toBase64(){const e=[];for(let t=0;t<this.sigBytes;t+=3){const r=(this.words[t>>>2]>>>24-t%4*8&255)<<16|(this.words[t+1>>>2]>>>24-(t+1)%4*8&255)<<8|this.words[t+2>>>2]>>>24-(t+2)%4*8&255;for(let s=0;s<4&&8*t+6*s<8*this.sigBytes;s++)e.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_".charAt(r>>>6*(3-s)&63))}return e.join("")}concat(e){if(this.words[this.sigBytes>>>2]&=4294967295<<32-this.sigBytes%4*8,this.words.length=Math.ceil(this.sigBytes/4),this.sigBytes%4)for(let t=0;t<e.sigBytes;t++){const r=e.words[t>>>2]>>>24-t%4*8&255;this.words[this.sigBytes+t>>>2]|=r<<24-(this.sigBytes+t)%4*8}else for(let t=0;t<e.sigBytes;t+=4)this.words[this.sigBytes+t>>>2]=e.words[t>>>2];this.sigBytes+=e.sigBytes}}function S(e){return t="string"==typeof(r=e)?`'${r}'`:(new B).serialize(r),(new O).finalize(t).toBase64();var t,r}var U=(e=>(e.CLEAR_ALL="clear_all",e.CLEAR_CURRENT="clear_current",e.CLEAR_PAGINATION="clear_pagination",e.KEEP_ALL="keep_all",e))(U||{});class P{constructor(e=3e5,t=50,r=!1){c(this,"cache",new Map),c(this,"cacheTime"),c(this,"maxSize"),c(this,"enableLog"),this.cacheTime=e,this.maxSize=t,this.enableLog=r}log(e,...t){this.enableLog}generateKey(e){return S(e)}generateTags(e){const t=new Set,r=Object.keys(e).filter(t=>!["current","size","total"].includes(t)&&void 0!==e[t]&&""!==e[t]&&null!==e[t]);if(r.length>0){const s=r.map(t=>`${t}:${String(e[t])}`).join("|");t.add(`search:${s}`)}else t.add("search:default");return t.add(`pagination:${e.size||10}`),t.add("pagination"),t}evictLRU(){if(this.cache.size<=this.maxSize)return;let e="",t=1/0,r=1/0;for(const[s,n]of this.cache.entries())(n.accessCount<t||n.accessCount===t&&n.lastAccessTime<r)&&(e=s,t=n.accessCount,r=n.lastAccessTime);e&&(this.cache.delete(e),this.log(`LRU 清理缓存: ${e}`))}set(e,t,r){const s=this.generateKey(e),n=this.generateTags(e),a=Date.now();this.evictLRU(),this.cache.set(s,{data:t,response:r,timestamp:a,params:s,tags:n,accessCount:1,lastAccessTime:a})}get(e){const t=this.generateKey(e),r=this.cache.get(t);return r?Date.now()-r.timestamp>this.cacheTime?(this.cache.delete(t),null):(r.accessCount++,r.lastAccessTime=Date.now(),r):null}clearByTags(e){let t=0;for(const[r,s]of this.cache.entries()){e.some(e=>Array.from(s.tags).some(t=>t.includes(e)))&&(this.cache.delete(r),t++)}return t}clearCurrentSearch(e){const t=this.generateKey(e);return this.cache.delete(t)?1:0}clearPagination(){return this.clearByTags(["pagination"])}clear(){this.cache.clear()}getStats(){const e=this.cache.size;let t=0,r=0;for(const s of this.cache.values())t+=JSON.stringify(s.data).length,r+=s.accessCount;return{total:e,size:`${(t/1024).toFixed(2)}KB`,hitRate:`${e>0?(r/e).toFixed(1):"0"} avg hits`}}cleanupExpired(){let e=0;const t=Date.now();for(const[r,s]of this.cache.entries())t-s.timestamp>this.cacheTime&&(this.cache.delete(r),e++);return e}}function D(e){return function(e){const{core:{apiFn:s,apiParams:n={},excludeParams:a=[],immediate:i=!0,columnsFactory:o,paginationKey:c},transform:{dataTransformer:u,responseAdapter:B=A}={},performance:{enableCache:R=!1,cacheTime:L=3e5,debounceTime:j=300,maxCacheSize:O=50}={},hooks:{onSuccess:T,onError:S,onCacheHit:D,resetFormCallback:I}={},debug:{enableLog:x=!1}={}}=e,N=(null==c?void 0:c.current)||w.paginationKey.current,k=(null==c?void 0:c.size)||w.paginationKey.size,K=d(0),M={log:(e,...t)=>{},warn:(e,...t)=>{},error:(e,...t)=>{}},F=R?new P(L,O,x):null,G=d("idle"),J=f(()=>"loading"===G.value),W=d(null),q=d([]);let H=null,Q=null;const V=g(Object.assign({[N]:1,[k]:10},n||{})),X=g({current:V[N]||1,size:V[k]||10,total:0}),{width:Y}=y(),Z=f(()=>{return e=l({},X),s={small:Y.value<768},t(e,r(s));var e,s}),ee=o?p(o):null,te=null==ee?void 0:ee.columns,re=null==ee?void 0:ee.columnChecks,se=f(()=>q.value.length>0),ne=f(()=>(K.value,F?F.getStats():{total:0,size:"0KB",hitRate:"0 avg hits"})),ae=E(S,x),ie=(e,t)=>{if(!F)return;let r=0;switch(e){case U.CLEAR_ALL:F.clear(),M.log(`清空所有缓存 - ${t||""}`);break;case U.CLEAR_CURRENT:r=F.clearCurrentSearch(V),M.log(`清空当前搜索缓存 ${r} 条 - ${t||""}`);break;case U.CLEAR_PAGINATION:r=F.clearPagination(),M.log(`清空分页缓存 ${r} 条 - ${t||""}`);break;case U.KEEP_ALL:default:M.log(`保持缓存不变 - ${t||""}`)}K.value++},oe=(e,...t)=>h(null,[e,...t],function*(e,t=R){H&&H.abort();const r=new AbortController;H=r,G.value="loading",W.value=null;try{let n=Object.assign({},V,{[N]:X.current,[k]:X.size},e||{});if(a.length>0){const e=l({},n);a.forEach(t=>{delete e[t]}),n=e}if(t&&F){const e=F.get(n);if(e){q.value=e.data,_(X,e.response);const t=V;return t[N]!==X.current&&(t[N]=X.current),t[k]!==X.size&&(t[k]=X.size),G.value="success",D&&D(e.data,e.response),M.log("缓存命中"),e.response}}const i=yield s(n);if(r.signal.aborted)throw new Error("请求已取消");const o=B(i);let c=z(o);u&&(c=u(c)),q.value=c,_(X,o);const h=V;return h[N]!==X.current&&(h[N]=X.current),h[k]!==X.size&&(h[k]=X.size),t&&F&&(F.set(n,c,o),K.value++,M.log("数据已缓存")),G.value="success",T&&T(c,o),o}catch(n){if(n instanceof Error&&"请求已取消"===n.message)return G.value="idle",{records:[],total:0,current:1,size:10};G.value="error",q.value=[];throw ae(n,"获取表格数据失败")}finally{H===r&&(H=null)}}),le=e=>h(null,null,function*(){try{return yield oe(e)}catch(t){return Promise.resolve()}}),ce=e=>h(null,null,function*(){X.current=1,V[N]=1,ie(U.CLEAR_CURRENT,"搜索数据");try{return yield oe(e,!1)}catch(t){return Promise.resolve()}}),ue=$(ce,j),he=()=>h(null,null,function*(){ue.cancel();const e=V,t={[N]:1,[k]:e[k]||10};Object.keys(V).forEach(t=>{delete e[t]}),Object.assign(V,n||{},t),X.current=1,X.size=t[k],W.value=null,ie(U.CLEAR_ALL,"重置搜索"),yield le(),I&&(yield b(),I())});let de=!1;const fe=e=>h(null,null,function*(){if(e<=0)return;ue.cancel();const t=V;X.size=e,X.current=1,t[k]=e,t[N]=1,ie(U.CLEAR_CURRENT,"分页大小变化"),yield le()}),ge=e=>h(null,null,function*(){if(!(e<=0||de))if(X.current!==e)try{de=!0;const t=V;X.current=e,t[N]!==e&&(t[N]=e),yield le()}finally{de=!1}else M.log("分页页码未变化，跳过请求")}),ye=()=>h(null,null,function*(){ue.cancel(),X.current=1,V[N]=1,ie(U.CLEAR_PAGINATION,"新增数据"),yield le()}),pe=()=>h(null,null,function*(){ie(U.CLEAR_CURRENT,"编辑数据"),yield le()}),me=()=>h(null,null,function*(){const{current:e}=X;ie(U.CLEAR_CURRENT,"删除数据"),yield le(),0===q.value.length&&e>1&&(X.current=e-1,V[N]=e-1,yield le())}),Ce=()=>h(null,null,function*(){ue.cancel(),ie(U.CLEAR_ALL,"手动刷新"),yield le()}),ve=()=>h(null,null,function*(){ie(U.CLEAR_CURRENT,"软刷新"),yield le()}),be=()=>{H&&H.abort(),ue.cancel()},Ae=()=>{q.value=[],W.value=null,ie(U.CLEAR_ALL,"清空数据")},we=()=>{if(!F)return 0;const e=F.cleanupExpired();return e>0&&K.value++,e};R&&F&&(Q=setInterval(()=>{const e=F.cleanupExpired();e>0&&(M.log(`自动清理 ${e} 条过期缓存`),K.value++)},L/2));i&&m(()=>h(null,null,function*(){yield le()}));return C(()=>{be(),F&&F.clear(),Q&&clearInterval(Q)}),l({data:q,loading:v(J),error:v(W),isEmpty:f(()=>0===q.value.length),hasData:se,pagination:v(X),paginationMobile:Z,handleSizeChange:fe,handleCurrentChange:ge,searchParams:V,resetSearchParams:he,fetchData:le,getData:ce,getDataDebounced:ue,clearData:Ae,refreshData:Ce,refreshSoft:ve,refreshCreate:ye,refreshUpdate:pe,refreshRemove:me,cacheInfo:ne,clearCache:ie,clearExpiredCache:we,cancelRequest:be},ee&&{columns:te,columnChecks:re,addColumn:ee.addColumn,removeColumn:ee.removeColumn,toggleColumn:ee.toggleColumn,updateColumn:ee.updateColumn,batchUpdateColumns:ee.batchUpdateColumns,reorderColumns:ee.reorderColumns,getColumnConfig:ee.getColumnConfig,getAllColumns:ee.getAllColumns,resetColumns:ee.resetColumns})}(e)}export{D as u};
