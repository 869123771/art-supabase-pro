import{aV as e,aW as t,aX as s,aY as i}from"./index-DocD4lg6.js";class n{constructor(e){this._defaults=e,this._worker=null,this._client=null,this._idleCheckInterval=window.setInterval(()=>this._checkIfIdle(),3e4),this._lastUsedTime=0,this._configChangeListener=this._defaults.onDidChange(()=>this._stopWorker())}_stopWorker(){this._worker&&(this._worker.dispose(),this._worker=null),this._client=null}dispose(){clearInterval(this._idleCheckInterval),this._configChangeListener.dispose(),this._stopWorker()}_checkIfIdle(){if(!this._worker)return;Date.now()-this._lastUsedTime>12e4&&this._stopWorker()}_getClient(){return this._lastUsedTime=Date.now(),this._client||(this._worker=e.createWebWorker({moduleId:this._defaults.languageId,label:this._defaults.languageId,createData:{languageId:this._defaults.languageId}}),this._client=this._worker.getProxy()),this._client}getLanguageServiceWorker(...e){const t=null==e?void 0:e.filter(Boolean);return this._getClient().then(e=>(t&&(null==t?void 0:t.length)&&this._worker&&this._worker.withSyncedResources(t),e))}}class o{constructor(t,s,i){this._languageId=t,this._worker=s,this._defaults=i,this._disposables=[],this._listener=Object.create(null);const n=e=>{let t=e.getLanguageId();t===this._languageId&&(this._listener[e.uri.toString()]=e.onDidChangeContent(function(e,t){let s=null;return(...i)=>{s&&clearTimeout(s),s=setTimeout(()=>{s&&clearTimeout(s),s=null,null==e||e(...i)},t)}}(()=>{this._doValidate(e.uri,t)},500)),this._doValidate(e.uri,t))},o=t=>{e.setModelMarkers(t,this._languageId,[]);let s=t.uri.toString(),i=this._listener[s];i&&(i.dispose(),delete this._listener[s])};this._disposables.push(e.onDidCreateModel(n)),this._disposables.push(e.onWillDisposeModel(o)),this._disposables.push(e.onDidChangeModelLanguage(e=>{o(e.model),n(e.model)})),this._disposables.push(this._defaults.onDidChange(t=>{e.getModels().forEach(e=>{e.getLanguageId()===this._languageId&&(o(e),n(e))})})),this._disposables.push({dispose:()=>{for(let e in this._listener)this._listener[e].dispose()}}),e.getModels().forEach(n)}dispose(){this._disposables.forEach(e=>e&&e.dispose()),this._disposables=[]}_doValidate(t,s){this._worker(t).then(s=>{var i;let n=(null===(i=e.getModel(t))||void 0===i?void 0:i.getValue())||"";return"function"==typeof this._defaults.preprocessCode&&(n=this._defaults.preprocessCode(n)),s.doValidation(n)}).then(i=>{const n=i.map(e=>{return t=e,{severity:r(),startLineNumber:t.startLine,startColumn:t.startColumn,endLineNumber:t.endLine,endColumn:t.endColumn,message:t.message,code:void 0,source:"dt-sql-parser"};var t});let o=e.getModel(t);o&&o.getLanguageId()===s&&e.setModelMarkers(o,s,n)}).then(void 0,e=>{})}}function r(e){return s.Error}class l{constructor(e,t){this._worker=e,this._defaults=t}get triggerCharacters(){return Array.isArray(this._defaults.triggerCharacters)?this._defaults.triggerCharacters:["."," "]}provideCompletionItems(s,i,n,o){const r=s.uri;return this._worker(r).then(t=>{var s;let n=(null===(s=e.getModel(r))||void 0===s?void 0:s.getValue())||"";return"function"==typeof this._defaults.preprocessCode&&(n=this._defaults.preprocessCode(n)),t.doCompletionWithEntities(n,i)}).then(({suggestions:e,allEntities:t,context:o})=>{let r=[];return(null==o?void 0:o.isStatementBeginning)&&(r=this._defaults.completionSnippets.map(e=>Object.assign(Object.assign({},e),{insertText:"string"==typeof e.body?e.body:e.body.join("\n")}))),this._defaults.completionService(s,i,n,e,t,r)}).then(e=>{const n=s.getWordUntilPosition(i),o=new t(i.lineNumber,n.startColumn,i.lineNumber,n.endColumn);return{suggestions:(Array.isArray(e)?e:e.suggestions).map(e=>{var t,s;return Object.assign(Object.assign({},e),{insertText:null!==(t=e.insertText)&&void 0!==t?t:"string"==typeof e.label?e.label:e.label.label,range:null!==(s=e.range)&&void 0!==s?s:o})}),dispose:Array.isArray(e)?void 0:e.dispose,incomplete:Array.isArray(e)?void 0:e.incomplete}})}}class u{constructor(e,t){this._worker=e,this._defaults=t}provideDefinition(e,s,i){const n=e.uri;return e.getLineContent(s.lineNumber).startsWith("--")?null:this._worker(n).then(t=>{let s=(null==e?void 0:e.getValue())||"";return"function"==typeof this._defaults.preprocessCode&&(s=this._defaults.preprocessCode(s)),t.getAllEntities(s)}).then(i=>{const n=e.getWordAtPosition(s);let o={line:-1,startColumn:-1,endColumn:-1};const r=null==i?void 0:i.find(e=>{const t=e.position;return t.startColumn===(null==n?void 0:n.startColumn)&&t.endColumn===(null==n?void 0:n.endColumn)&&t.line===s.lineNumber?e:null});if(r)for(let e in i){const t=i[Number(e)];if(t.entityContextType.includes("Create")&&(null==n?void 0:n.word)&&t.text===(null==n?void 0:n.word)&&t.entityContextType.includes(r.entityContextType)){o=t.position;break}}if(o&&-1!==o.line)return{uri:e.uri,range:new t(null==o?void 0:o.line,null==o?void 0:o.startColumn,null==o?void 0:o.line,null==o?void 0:o.endColumn)}})}}class a{constructor(e,t){this._worker=e,this._defaults=t}provideReferences(e,s,i,n){const o=e.uri;if(e.getLineContent(s.lineNumber).startsWith("CREATE"))return this._worker(o).then(t=>{let s=(null==e?void 0:e.getValue())||"";return"function"==typeof this._defaults.preprocessCode&&(s=this._defaults.preprocessCode(s)),t.getAllEntities(null==e?void 0:e.getValue())}).then(i=>{const n=e.getWordAtPosition(s),o=[],r=null==i?void 0:i.find(e=>{const t=e.position;return t.startColumn===(null==n?void 0:n.startColumn)&&t.endColumn===(null==n?void 0:n.endColumn)&&t.line===s.lineNumber?e:null});return r&&(null==i||i.forEach(s=>{if((null==n?void 0:n.word)&&s.text===(null==n?void 0:n.word)&&r.entityContextType.includes(s.entityContextType)){let i=null;i=s.position,o.push({uri:e.uri,range:new t(null==i?void 0:i.line,null==i?void 0:i.startColumn,null==i?void 0:i.line,null==i?void 0:i.endColumn)})}})),o})}}function d(e){const t=[],s=[],r=new n(e);t.push(r);const d=(...e)=>r.getLanguageServiceWorker(...e);return function(){const{languageId:t,modeConfiguration:n}=e;c(s),n.diagnostics&&s.push(new o(t,d,e)),n.completionItems.enable&&s.push(i.registerCompletionItemProvider(t,new l(d,e))),n.references&&s.push(i.registerReferenceProvider(t,new a(d,e))),n.definitions&&s.push(i.registerDefinitionProvider(t,new u(d,e)))}(),t.push(h(s)),h(t)}function h(e){return{dispose:()=>c(e)}}function c(e){for(var t;e.length;)null===(t=e.pop())||void 0===t||t.dispose()}export{d as setupLanguageMode};
