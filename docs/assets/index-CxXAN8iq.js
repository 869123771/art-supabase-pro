var e=(e,t,r)=>new Promise((n,a)=>{var i=e=>{try{s(r.next(e))}catch(t){a(t)}},o=e=>{try{s(r.throw(e))}catch(t){a(t)}},s=e=>e.done?n(e.value):Promise.resolve(e.value).then(i,o);s((r=r.apply(e,t)).next())});import{x as t,dw as r,dx as n}from"./index-BKps0qP8.js";const{supabase:a,responseHandle:i}=r();function o(t){return e(this,null,function*(){const{table:e,field:r,value:n,excludeId:o,extraWhere:s}=t;let c=a.from(e).select("id",{count:"exact",head:!0}).eq(r,n);return o&&(c=c.neq("id",o)),s&&Object.entries(s).forEach(([e,t])=>{null!=t&&(c=c.eq(e,t))}),yield i(()=>c,{ignoreCheck:!0})})}function s(r,o){return e(this,null,function*(){const{getUserInfo:{userName:o,nickName:s}}=t(),{bucket:l="attachments",createBy:u=o||s,remark:d="",concurrency:f=3}={},h=Array.isArray(r)?r:[r],y=[...h],m=[];return yield Promise.all(Array.from({length:Math.min(f,h.length)},()=>function(){return e(this,null,function*(){for(;y.length;){const t=y.shift();if(!t)return;try{const e=yield p(t);m.push(e)}catch(e){}}})}())),m;function p(t){return e(this,null,function*(){const r=yield function(t){return e(this,null,function*(){const e=yield t.arrayBuffer(),r=yield crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(r)).map(e=>e.toString(16).padStart(2,"0")).join("")})}(t),{data:o}=yield a.from("attachment").select("*").eq("hash",r).maybeSingle();if(o)return o;const s=t.name.split(".").pop()||"",f=`${r}.${s}`,h=n().format("YYYY/MM/DD"),y=`${h}/${f}`;yield i(()=>a.storage.from(l).upload(y,t,{upsert:!1,contentType:t.type}),{breakReturn:!0,showMessage:!1});const{data:m}=yield i(()=>a.storage.from(l).getPublicUrl(y),{ignoreCheck:!0}),p={storage_mode:"supabase",origin_name:t.name,object_name:f,hash:r,mime_type:t.type,storage_path:h,suffix:s,size_byte:t.size,size_info:c(t.size),url:m.publicUrl,create_by:u,update_by:u,remark:d},g=yield a.from("attachment").insert(p).select().single();return yield i(()=>g,{ignoreCheck:!0,showMessage:!0})})}})}function c(e){return e<1024?e+" B":e<1048576?(e/1024).toFixed(2)+" KB":e<1073741824?(e/1024/1024).toFixed(2)+" MB":(e/1024/1024/1024).toFixed(2)+" GB"}export{o as c,s as u};
